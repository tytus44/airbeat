<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIRBEAT Radio v1.2</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        :root {
            /* TEMA AIRBEAT: Cyber-Violet */
            --bg-deep: #130b1b;       /* Viola scurissimo */
            --header-bg: #130b1b; 
            --panel-bg: #1e1229;      /* Viola scuro */
            --border-color: #352247;
            
            --accent: #d946ef;        /* Fucsia Neon */
            --accent-hover: #c026d3;
            --accent-sec: #06b6d4;    /* Ciano */
            
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #a78bfa;    /* Viola chiaro */
            
            --header-height: 70px;
            
            /* DESIGN SYSTEM */
            --radius-pill: 50px; 
            --radius-card: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(217, 70, 239, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(217, 70, 239, 0.4); }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            margin: 0; height: 100vh; width: 100vw;
            overflow: hidden;
            font-weight: 300;
            display: flex; 
            flex-direction: column; 
        }

        /* --- BRANDING --- */
        .brand-dot {
            color: var(--accent);
            font-weight: 700;
            display: inline-block;
            transform: scale(1.5);
            margin: 0 1px;
            text-shadow: 0 0 10px var(--accent);
        }

        /* --- INTRO --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-deep); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s, visibility 0.8s;
        }
        .intro-logo { width: 80px; height: 80px; color: var(--accent); z-index: 2; filter: drop-shadow(0 0 15px var(--accent)); }
        .intro-text { margin-top: 20px; font-weight: 600; letter-spacing: 4px; color: var(--text-muted); font-size: 28px; text-transform: uppercase; }
        .ripple {
            position: absolute; border-radius: 50%; border: 2px solid var(--accent); opacity: 0;
            animation: ripple-anim 2s infinite cubic-bezier(0, 0.2, 0.8, 1);
        }
        .ripple:nth-child(2) { animation-delay: 0.5s; }
        @keyframes ripple-anim { 0% { width: 60px; height: 60px; opacity: 1; stroke-width: 2px; } 100% { width: 300px; height: 300px; opacity: 0; stroke-width: 0px; } }

        /* --- TOP BAR --- */
        .top-bar {
            position: relative; 
            width: 100%; 
            height: var(--header-height);
            flex: 0 0 var(--header-height);
            background: var(--header-bg); 
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 2000; gap: 20px;
            transition: all 0.3s ease;
        }

        .brand { display: flex; align-items: center; gap: 12px; color: white; text-decoration: none; flex-shrink: 0; transition: opacity 0.2s; white-space: nowrap; }
        .brand-logo { width: 28px; height: 28px; color: var(--accent); }
        .brand-name { font-size: 20px; font-weight: 600; letter-spacing: 2px; }

        /* SEARCH BAR */
        .search-wrapper {
            flex: 1; max-width: 400px; position: relative; display: flex; align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            border-radius: var(--radius-pill);
            padding: 10px 40px 10px 40px; color: white; outline: none;
            font-family: 'Montserrat'; font-size: 14px; font-weight: 300; margin-bottom: 0;
            transition: all 0.2s;
        }
        .search-input:focus { background: rgba(255,255,255,0.1); border-color: var(--accent); box-shadow: 0 0 10px rgba(217, 70, 239, 0.2); }
        
        .search-icon-left { 
            position: absolute; left: 12px; color: var(--text-muted); width: 18px; height: 18px; 
            z-index: 5; pointer-events: none; transition: color 0.3s;
        }
        
        .search-clear-wrapper {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            width: 30px; height: 30px; display: none; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; border-radius: 50%; transition: background 0.2s;
        }
        .search-clear-wrapper:hover { background: rgba(255,255,255,0.1); }
        .search-clear-wrapper .lucide { width: 16px; height: 16px; color: var(--text-muted); }
        .search-clear-wrapper:hover .lucide { color: white; }

        .nav-menu { display: flex; gap: 10px; align-items: center; flex-shrink: 0; transition: opacity 0.2s; }
        
        .menu-link {
            appearance: none; -webkit-appearance: none;
            background-color: transparent; border: 1px solid transparent;
            color: var(--text-muted);
            font-family: 'Montserrat', sans-serif; font-weight: 300; font-size: 14px;
            cursor: pointer; padding: 8px 16px; 
            border-radius: var(--radius-pill);
            transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .menu-link:hover { color: white; background-color: rgba(255,255,255,0.05); }
        .menu-link.active { 
            color: var(--accent); background-color: rgba(217, 70, 239, 0.1); 
            border-color: rgba(217, 70, 239, 0.2); font-weight: 600; 
        }
        .menu-link .lucide { width: 18px; height: 18px; }
        .menu-icon-only { padding: 8px; }
        .menu-icon-only span { display: none; }

        /* --- CONTENT AREA --- */
        .content-container {
            flex: 1; overflow-y: auto; padding: 40px; 
            scroll-behavior: smooth; transition: opacity 0.3s;
        }

        .view-section { display: none; animation: fadeIn 0.4s; max-width: 1000px; margin: 0 auto; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { font-weight: 300; color: white; margin-top: 0; margin-bottom: 25px; letter-spacing: 1px; }
        h2 { font-size: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; color: var(--accent); }

        /* --- LIBRARY HEADER --- */
        .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .library-header h1 { margin: 0; }
        
        .sort-group {
            display: flex; background: var(--panel-bg);
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-pill);
            padding: 4px; gap: 4px;
        }
        .sort-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 6px 12px; border-radius: var(--radius-pill);
            cursor: pointer; font-family: 'Montserrat'; font-size: 12px; font-weight: 500;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .sort-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .sort-btn.active { background: var(--accent); color: white; }
        .sort-btn .lucide { width: 14px; height: 14px; }

        /* --- GRID --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        
        .podcast-card {
            background: var(--panel-bg); border: 1px solid var(--border-color); 
            border-radius: var(--radius-card);
            padding: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; 
            transition: transform 0.2s, border-color 0.2s; cursor: pointer;
        }
        .podcast-card:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .card-image { width: 100%; aspect-ratio: 1/1; background: #0f172a; border-radius: 8px; object-fit: cover; margin-bottom: 15px; pointer-events: none; border: 1px solid rgba(255,255,255,0.05); }
        .card-title { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; }
        .card-sub { font-size: 11px; color: var(--accent-sec); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        .fav-badge { position: absolute; top: 10px; left: 10px; color: var(--danger); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); z-index: 10; }
        .fav-badge .lucide { fill: var(--danger); width: 20px; height: 20px; }

        /* --- SEARCH RESULTS --- */
        .search-results-list { display: flex; flex-direction: column; gap: 10px; }
        .search-item { 
            background: var(--panel-bg); border: 1px solid var(--border-color); 
            border-radius: 16px; padding: 15px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .search-item:hover { border-color: var(--accent); background: rgba(217, 70, 239, 0.05); }
        .search-meta { flex: 1; padding-right: 20px; overflow: hidden; }
        .search-ep-title { font-weight: 600; color: white; margin-bottom: 4px; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-pod-name { font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; display:flex; gap:6px; align-items:center; }
        .search-loading { text-align: center; padding: 40px; color: var(--text-muted); font-style: italic; }

        /* --- GESTIONE --- */
        .manage-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .manage-card { background: var(--panel-bg); padding: 30px; border-radius: var(--radius-card); border: 1px solid var(--border-color); }
        
        input { 
            width: 100%; padding: 14px; background: var(--bg-deep); border: 1px solid var(--border-color); color: white; 
            border-radius: var(--radius-pill);
            margin-bottom: 20px; font-family: 'Montserrat'; font-size:14px; font-weight: 300; 
        }
        input:focus { outline: none; border-color: var(--accent); }
        
        .btn-primary { 
            width: 100%; padding: 14px; background: var(--accent); color: white; border: none; 
            border-radius: var(--radius-pill);
            font-weight: 600; cursor: pointer; font-family: 'Montserrat'; font-size: 14px; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 0 15px rgba(217, 70, 239, 0.4); }
        a.btn-primary { display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; box-sizing: border-box; }
        
        .btn-secondary { 
            width: 100%; padding: 14px; background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); 
            border-radius: var(--radius-pill);
            font-weight: 400; cursor: pointer; margin-top: 10px; font-family: 'Montserrat'; font-size: 14px; 
        }
        .btn-secondary:hover { border-color: var(--text-muted); color: white; }

        /* --- DETAILS --- */
        .details-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .details-actions { display: flex; gap: 15px; }
        .tool-btn { 
            background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); 
            padding: 8px 16px; border-radius: var(--radius-pill);
            cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'Montserrat'; font-size: 13px; font-weight: 400; transition: 0.2s; 
        }
        .tool-btn:hover { border-color: var(--text-muted); color: white; }
        .tool-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
        .tool-btn.active-fav { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .tool-btn.active-fav .lucide { fill: var(--danger); }
        
        .header-flex { display: flex; gap: 30px; margin-bottom: 30px; align-items: center; }
        .detail-img-style { width: 180px; height: 180px; border-radius: 20px; object-fit:cover; border: 2px solid var(--border-color); flex-shrink: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .live-indicator {
            display: inline-flex; align-items: center; gap: 6px; 
            padding: 4px 10px; border-radius: 20px; 
            background: rgba(239, 68, 68, 0.1); color: var(--danger);
            font-size: 12px; font-weight: 700; border: 1px solid rgba(239, 68, 68, 0.3);
            margin-bottom: 10px;
        }
        .live-dot { width: 8px; height: 8px; background: var(--danger); border-radius: 50%; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

        /* --- PLAYER PILL & ZEN --- */
        .player-pill {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: 90%; max-width: 450px; height: 75px;
            background: rgba(30, 18, 41, 0.85); 
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            display: flex; align-items: center; padding: 0 25px; gap: 15px;
            z-index: 5000; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }
        .player-pill.visible { transform: translateX(-50%) translateY(0); }
        .pill-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; z-index: 2; cursor: pointer; }
        .pill-title { font-weight: 600; font-size: 14px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: font-size 0.3s; }
        .pill-status { font-size: 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; transition: font-size 0.3s; display:flex; align-items:center; gap:4px; }
        .pill-controls { display: flex; align-items: center; gap: 12px; z-index: 2; }
        
        .pill-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .pill-btn:hover { color: white; }
        
        /* PULSANTE ZEN NEUTRO */
        .pill-btn.zen-toggle-btn {
            background: rgba(255,255,255,0.1); /* Sfondo Neutro */
            border-radius: 50%;
            width: 40px; height: 40px;
        }
        .pill-btn.zen-toggle-btn:hover { background: rgba(255,255,255,0.2); }

        .pill-btn.main { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(217, 70, 239, 0.5); transition: all 0.3s; }
        .pill-btn.main:hover { transform: scale(1.05); background: var(--accent-hover); }
        
        /* Progress as Live Signal */
        .pill-progress-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); z-index: 3; }
        .pill-progress-fill { width: 100%; height: 100%; background: linear-gradient(90deg, var(--bg-deep), var(--accent), var(--bg-deep)); opacity: 0.5; animation: signal-flow 2s infinite linear; }
        @keyframes signal-flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* ZEN UI */
        #zen-mode-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-deep); display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 4000; padding-bottom: 140px; overflow: hidden;
        }
        .zen-bg-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; }
        
        body.zen-active #zen-mode-container { display: flex; }
        body.zen-active .top-bar, body.zen-active .content-container, body.zen-active #fab-top { display: none; }
        
        body.zen-active .player-pill {
            width: auto; min-width: 280px; height: 90px; bottom: 60px; padding: 0 40px;
            background: rgba(30, 18, 41, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            justify-content: center; flex-direction: row;
        }
        
        body.zen-active .pill-info { display: none !important; }
        body.zen-active .pill-btn.zen-toggle-btn { display: none; }
        body.zen-active .pill-controls { width: 100%; justify-content: center; gap: 40px; }
        body.zen-active .pill-btn.main { width: 70px; height: 70px; }
        body.zen-active .pill-btn.main .lucide { width: 32px; height: 32px; }

        .zen-exit-btn {
            position: absolute; top: 30px; right: 30px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5000; transition: 0.2s;
        }
        .zen-exit-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }

        /* ZEN COVER SENZA ROTAZIONE */
        .zen-cover { 
            width: 300px; height: 300px; border-radius: 50%; object-fit: cover; 
            box-shadow: 0 0 80px rgba(217, 70, 239, 0.3); margin-bottom: 40px; 
            border: 4px solid rgba(255,255,255,0.1); position: relative; z-index: 10; 
            background: var(--bg-deep); 
            /* Rotazione rimossa */
        }
        
        .zen-title { font-size: 32px; color: white; text-align: center; max-width: 90%; font-weight: 700; line-height: 1.2; text-shadow: 0 0 20px rgba(217, 70, 239, 0.6); z-index: 10; letter-spacing: 2px; }
        .zen-podcast-name { font-size: 16px; color: var(--accent-sec); margin-top: 15px; text-transform: uppercase; letter-spacing: 4px; font-weight: 500; z-index: 10; }

        /* MODAL & FAB */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: var(--panel-bg); border: 1px solid var(--border-color); width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; } .modal-actions button { flex: 1; }
        
        .fab-scroll {
            position: fixed; bottom: 40px; right: 40px; width: 45px; height: 45px; border-radius: 50%;
            background-color: var(--accent); color: white; border: none;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(217, 70, 239, 0.4);
            cursor: pointer; opacity: 0; pointer-events: none; transform: translateY(20px); transition: all 0.3s; z-index: 4000;
        }
        .fab-scroll.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* --- RESPONSIVE --- */
        @media (max-width: 800px) {
            .top-bar { padding: 0 15px; }
            .brand-name { display: none; }
            .nav-menu { gap: 5px; }
            .menu-link span { display: none; }
            .menu-link { padding: 8px; }

            .search-wrapper { max-width: 40px; margin-right: 0; padding: 0; background: transparent; justify-content: flex-end; cursor: pointer; }
            .search-icon-left { position: relative; left: auto; right: 0; width: 20px; height: 20px; pointer-events: auto; color: var(--text-muted); }
            .search-input { width: 0; padding: 0; opacity: 0; border: none; pointer-events: none; }
            
            .top-bar.search-active { gap: 0; }
            .top-bar.search-active .brand, .top-bar.search-active .nav-menu { display: none; }
            .top-bar.search-active .search-wrapper { width: 100%; max-width: 100%; display: flex; align-items: center; cursor: default; }
            .top-bar.search-active .search-input { display: block; width: 100%; padding: 20px 40px; opacity: 1; pointer-events: auto; border: 1px solid var(--border-color); background: rgba(255,255,255,0.05); }
            .top-bar.search-active .search-icon-left { position: absolute; left: 12px; pointer-events: auto; cursor: pointer; z-index: 20; }
            
            .manage-grid { grid-template-columns: 1fr; gap: 20px; }
            .content-container { padding: 20px; padding-bottom: 120px; }
            .header-flex { flex-direction: column; text-align: center; align-items: center;}
            .details-toolbar { flex-wrap: wrap; gap: 10px; justify-content: space-between; }
            
            .player-pill { bottom: 20px; width: 92%; }
            .zen-cover { width: 220px; height: 220px; margin-bottom: 20px; border-width: 2px; }
            .zen-title { font-size: 24px; }
            
            body.zen-active .player-pill { height: 80px; width: 90%; min-width: 250px; flex-direction: row; padding: 10px 30px; bottom: 50px; }
            body.zen-active .pill-btn.main { width: 60px; height: 60px; }
            .zen-bg-svg { display: none; }
        }
    </style>
</head>
<body>

    <audio id="global-audio" crossorigin="anonymous"></audio>

    <div id="splash-screen">
        <div style="position: relative; display: flex; justify-content: center; align-items: center;">
            <div class="ripple"></div><div class="ripple"></div>
            <i data-lucide="radio-tower" class="intro-logo"></i>
        </div>
        <div class="intro-text">AIRBEAT<span class="brand-dot">.</span></div>
    </div>

    <div id="app-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-icon-container" style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h3 id="modal-title" style="margin: 0 0 10px 0; color:white">Titolo</h3>
            <div id="modal-body" style="color: var(--text-muted); font-size: 14px;">Messaggio</div>
            <div id="modal-buttons" class="modal-actions"></div>
        </div>
    </div>

    <div id="zen-mode-container">
        <svg class="zen-bg-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <defs>
                <linearGradient id="Grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#4c1d95" stop-opacity="0.6"/>
                    <stop offset="100%" stop-color="#130b1b" stop-opacity="0"/>
                </linearGradient>
                <radialGradient id="Grad2" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#d946ef" stop-opacity="0.4"/>
                    <stop offset="100%" stop-color="#130b1b" stop-opacity="0"/>
                </radialGradient>
            </defs>
            <rect width="100%" height="100%" fill="#130b1b"/>
            <circle cx="20" cy="80" r="40" fill="url(#Grad1)">
                <animate attributeName="cx" values="20;80;20" dur="20s" repeatCount="indefinite"/>
            </circle>
            <circle cx="80" cy="20" r="30" fill="url(#Grad2)">
                <animate attributeName="cy" values="20;80;20" dur="15s" repeatCount="indefinite"/>
                <animate attributeName="r" values="30;50;30" dur="10s" repeatCount="indefinite"/>
            </circle>
        </svg>

        <button class="zen-exit-btn" onclick="toggleZenMode()" title="Esci da Zen Mode">
            <i data-lucide="minimize-2"></i>
        </button>

        <img id="zen-cover" src="" class="zen-cover">
        <div id="zen-title" class="zen-title">Nessuna trasmissione</div>
        <div id="zen-podcast-name" class="zen-podcast-name"></div>
        <div style="margin-top:20px; color:var(--accent); font-size:12px; letter-spacing:2px; font-weight:700">LIVE AIRWAVES</div>
    </div>

    <header class="top-bar" id="top-bar">
        <div class="brand">
            <i data-lucide="radio" class="brand-logo"></i>
            <span class="brand-name">AIRBEAT<span class="brand-dot">.</span></span>
        </div>
        
        <div class="search-wrapper">
            <i data-lucide="search" class="search-icon-left" onclick="toggleMobileSearch()"></i>
            <input type="text" id="search-input" class="search-input" placeholder="Cerca stazioni globali...">
            <div id="search-clear-wrapper" class="search-clear-wrapper" onclick="clearSearch()">
                <i data-lucide="x"></i>
            </div>
        </div>

        <nav class="nav-menu">
            <button class="menu-link active" onclick="switchView('view-library', this)">
                <i data-lucide="library"></i> <span>Tuner</span>
            </button>
            <button class="menu-link" onclick="switchView('view-manage', this)">
                <i data-lucide="settings-2"></i> <span>Gestione</span>
            </button>
            <button class="menu-link menu-icon-only" onclick="toggleAppFullscreen()" title="Fullscreen">
                <i data-lucide="maximize"></i>
            </button>
            <button class="menu-link menu-icon-only" onclick="showInfo()" title="Info">
                <i data-lucide="info"></i>
            </button>
        </nav>
    </header>

    <div id="pill-player" class="player-pill">
        <div class="pill-progress-bg">
            <div class="pill-progress-fill"></div>
        </div>
        <div class="pill-info" onclick="openCurrentStationView()">
            <div class="pill-status"><div class="live-dot" style="width:6px; height:6px;"></div> IN ONDA</div>
            <div id="pill-title" class="pill-title">Nessuna radio</div>
        </div>
        <div class="pill-controls">
            <button class="pill-btn zen-toggle-btn" onclick="toggleZenMode()" title="Zen Mode"><i data-lucide="maximize-2"></i></button>
            <button id="pill-play-btn" class="pill-btn main" onclick="toggleGlobalPlay()"><i data-lucide="play"></i></button>
        </div>
    </div>

    <button id="fab-top" class="fab-scroll" onclick="scrollToTop()">
        <i data-lucide="arrow-up"></i>
    </button>

    <div class="content-container" id="scroll-container">
        
        <div id="view-library" class="view-section active">
            <div class="library-header">
                <h1 id="library-title">Le mie Stazioni</h1>
                <div class="sort-group">
                    <button id="sort-btn-name" class="sort-btn active" onclick="setSort('name')" title="Nome">A-Z</button>
                    <button id="sort-btn-fav" class="sort-btn" onclick="setSort('fav')" title="Preferiti"><i data-lucide="heart" style="width:14px"></i></button>
                    <button id="sort-btn-country" class="sort-btn" onclick="setSort('country')" title="Paese"><i data-lucide="globe" style="width:14px"></i></button>
                </div>
            </div>
            <div id="library-grid-content" class="grid-container"></div>
            <div id="search-results-container" class="search-results-list" style="display:none;"></div>
            <div id="empty-state" style="text-align: center; display:none; margin-top:80px; color:var(--text-muted)">
                <i data-lucide="radio-receiver" style="width:48px; height:48px; opacity:0.5; margin-bottom:10px"></i>
                <p>Nessuna stazione salvata.<br>Usa la ricerca per sintonizzarti.</p>
            </div>
        </div>

        <div id="view-manage" class="view-section">
            <h1>Gestione Sorgenti</h1>
            <div class="manage-grid">
                <div class="manage-card">
                    <h2>Editor Stazione</h2>
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:15px">Modifica o Aggiungi manualmente.</p>
                    <input type="hidden" id="inp-id">
                    <input type="url" id="inp-url" placeholder="http://stream-url...">
                    <input type="text" id="inp-name" placeholder="Nome Stazione">
                    <input type="text" id="inp-country" placeholder="Paese (es. Italy)">
                    <input type="text" id="inp-img" placeholder="URL Immagine (opzionale)">
                    <button class="btn-primary" id="btn-save">Salva Modifiche</button>
                    <button class="btn-secondary" onclick="resetForm()">Pulisci Campi</button>
                </div>
                <div class="manage-card">
                    <h2>Backup Frequenze</h2>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px; line-height:1.6">Esporta la lista delle tue stazioni preferite.</p>
                    <button class="btn-primary" id="btn-export" style="margin-bottom:10px">Esporta JSON</button>
                    <button class="btn-secondary" id="btn-import">Importa JSON</button>
                    <input type="file" id="file-import" style="display:none" accept=".json">
                </div>
                <div class="manage-card">
                    <h2>Radio Browser API</h2>
                    <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px; line-height:1.6">Powered by Community Radio Browser.</p>
                    <a href="https://www.radio-browser.info/" target="_blank" class="btn-secondary"><i data-lucide="globe"></i> Visita Sito</a>
                </div>
            </div>
        </div>

        <div id="view-player-details" class="view-section">
            <div class="details-toolbar">
                <button class="tool-btn" onclick="switchView('view-library', document.querySelector('.menu-link'))">
                    <i data-lucide="arrow-left"></i> <span>Tuner</span>
                </button>
                <div class="details-actions">
                    <button id="btn-fav-current" class="tool-btn"><i data-lucide="heart"></i> <span>Preferito</span></button>
                    <button id="btn-edit-current" class="tool-btn"><i data-lucide="pencil"></i> <span>Modifica</span></button>
                    <button id="btn-delete-current" class="tool-btn danger"><i data-lucide="trash-2"></i> <span>Rimuovi</span></button>
                </div>
            </div>
            
            <div class="header-flex" style="align-items: center; justify-content: center; text-align: center;">
                <img id="detail-img" src="" class="detail-img-style">
                <div style="text-align: left; max-width: 400px;">
                    <div class="live-indicator"><div class="live-dot"></div> LIVE STREAM</div>
                    <h2 id="detail-title" style="margin:0; color:white; border:none; padding:0; font-size:28px; font-weight:700">...</h2>
                    <p id="detail-meta" style="color:var(--accent-sec); font-size:14px; margin-top:5px; font-weight:500">...</p>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button id="detail-play-btn" class="pill-btn main" style="width:60px; height:60px;" onclick="toggleGlobalPlay()">
                            <i data-lucide="play" style="width:28px; height:28px"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div style="margin-top:40px; border-top:1px solid var(--border-color); padding-top:20px;">
                <h3 style="color:var(--text-muted); font-size:14px; text-transform:uppercase;">Informazioni Tecniche</h3>
                <div style="background:var(--panel-bg); padding:20px; border-radius:10px; font-size:13px; color:white; line-height:1.8;">
                    <div><strong>URL:</strong> <span id="detail-url" style="color:var(--text-muted); word-break:break-all;"></span></div>
                    <div><strong>Codec:</strong> <span id="detail-codec">Rilevamento...</span></div>
                    <div><strong>Bitrate:</strong> <span id="detail-bitrate">--</span></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let myStations = [];
        const STORAGE_KEY = 'AIRBEAT_RADIO_v1';
        const audio = document.getElementById('global-audio');
        
        // Player Elements
        const pillPlayer = document.getElementById('pill-player');
        const pillTitle = document.getElementById('pill-title');
        const pillPlayBtn = document.getElementById('pill-play-btn');
        const detailPlayBtn = document.getElementById('detail-play-btn');
        
        // Zen Elements
        const zenCover = document.getElementById('zen-cover');
        const zenTitle = document.getElementById('zen-title');
        const zenPodName = document.getElementById('zen-podcast-name');

        let currentPlayingStation = null;
        let searchTimeout = null;
        let currentSort = "name";

        // API Base (Using de1 mirror for reliability)
        const RADIO_API_BASE = "https://de1.api.radio-browser.info/json/stations";

        window.onload = () => { 
            lucide.createIcons();
            loadData(); 
            applySort(); 
            setTimeout(() => {
                const s = document.getElementById('splash-screen');
                s.style.opacity = '0'; setTimeout(() => s.style.visibility='hidden', 800);
            }, 2000);
        };

        const scrollContainer = document.getElementById('scroll-container');
        const fab = document.getElementById('fab-top');
        scrollContainer.addEventListener('scroll', () => {
            if (scrollContainer.scrollTop > 300) fab.classList.add('visible');
            else fab.classList.remove('visible');
        });
        function scrollToTop() { scrollContainer.scrollTo({ top: 0, behavior: 'smooth' }); }

        // --- DYNAMIC COVER GENERATOR ---
        function getDynamicCover(name) {
            if(!name) name = "RA";
            const initials = name.substring(0, 2).toUpperCase();
            const colors = ['#4c1d95', '#7c3aed', '#d946ef', '#ec4899', '#f43f5e', '#0ea5e9', '#06b6d4', '#14b8a6'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const color = colors[Math.abs(hash) % colors.length];

            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">
                <rect width="100%" height="100%" fill="${color}"/>
                <text x="50%" y="50%" dy=".35em" fill="white" font-family="'Montserrat', sans-serif" font-size="80" font-weight="bold" text-anchor="middle">
                    ${initials}
                </text>
            </svg>`;
            return "data:image/svg+xml;base64," + btoa(svg);
        }

        window.handleImageError = function(img, name) {
            img.onerror = null; 
            img.src = getDynamicCover(name);
        };

        // --- MOBILE SEARCH LOGIC ---
        function toggleMobileSearch() {
            if (window.innerWidth <= 800) {
                const topBar = document.getElementById('top-bar');
                const searchInput = document.getElementById('search-input');
                const icon = document.querySelector('.search-icon-left');

                if (topBar.classList.contains('search-active')) {
                    topBar.classList.remove('search-active');
                    icon.setAttribute('data-lucide', 'search');
                    lucide.createIcons();
                    if(searchInput.value === '') { clearSearch(); }
                } else {
                    topBar.classList.add('search-active'); 
                    icon.setAttribute('data-lucide', 'arrow-left');
                    lucide.createIcons();
                    setTimeout(() => searchInput.focus(), 100); 
                }
            }
        }

        // SEARCH RADIO BROWSER
        const searchInput = document.getElementById('search-input');
        const searchClearWrapper = document.getElementById('search-clear-wrapper');
        const libTitle = document.getElementById('library-title');
        const gridContent = document.getElementById('library-grid-content');
        const searchResults = document.getElementById('search-results-container');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            if(query.length > 0) {
                searchClearWrapper.style.display = 'flex';
                if(!document.getElementById('view-library').classList.contains('active')) switchView('view-library', document.querySelector('.menu-link'));
            } else {
                searchClearWrapper.style.display = 'none';
                resetSearchView();
                return;
            }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { if(query.length > 2) performGlobalSearch(query); }, 800);
        });

        function clearSearch() { 
            searchInput.value = ''; 
            searchClearWrapper.style.display = 'none'; 
            if(window.innerWidth <= 800) {
                document.getElementById('top-bar').classList.remove('search-active');
                document.querySelector('.search-icon-left').setAttribute('data-lucide', 'search');
                lucide.createIcons();
            }
            resetSearchView(); 
        }
        function resetSearchView() { libTitle.innerText = "Le mie Stazioni"; gridContent.style.display = 'grid'; searchResults.style.display = 'none'; searchResults.innerHTML = ''; renderLibrary(); }

        async function performGlobalSearch(query) {
            libTitle.innerText = `Sintonizzazione: "${query}"...`;
            gridContent.style.display = 'none';
            searchResults.style.display = 'flex';
            searchResults.innerHTML = '<div class="search-loading">Ricerca frequenze...</div>';
            
            try {
                const res = await fetch(`${RADIO_API_BASE}/search?name=${encodeURIComponent(query)}&limit=30&hidebroken=true&order=clickcount&reverse=true`);
                const data = await res.json();
                renderSearchResults(data, query);
            } catch(e) {
                searchResults.innerHTML = '<div class="search-loading" style="color:var(--danger)">Errore di connessione al satellite.</div>';
            }
        }

        function renderSearchResults(results, query) {
            searchResults.innerHTML = '';
            if(results.length === 0) { searchResults.innerHTML = '<div class="search-loading">Nessuna stazione trovata.</div>'; libTitle.innerText = `Risultati per "${query}" (0)`; return; }
            libTitle.innerText = `Trovate: "${query}" (${results.length})`;
            
            results.forEach(r => {
                const div = document.createElement('div'); div.className = 'search-item';
                
                const stationObj = {
                    id: r.stationuuid,
                    name: r.name,
                    url: r.url_resolved || r.url,
                    image: r.favicon || '',
                    country: r.country,
                    tags: r.tags,
                    favorite: false
                };

                const isSaved = myStations.some(s => s.id === stationObj.id);
                const actionBtn = isSaved 
                    ? `<button class="tool-btn active-fav" onclick="deleteStation('${stationObj.id}', true)"><i data-lucide="check"></i></button>`
                    : `<button class="tool-btn" onclick='addFromSearch(${JSON.stringify(stationObj).replace(/'/g, "&#39;")})'><i data-lucide="plus"></i></button>`;

                const playBtn = `<button class="play-circle" style="width:36px; height:36px; border-radius:50%; background:var(--accent); border:none; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick='previewStation(${JSON.stringify(stationObj).replace(/'/g, "&#39;")})'><i data-lucide="play" style="width:16px;"></i></button>`;

                const safeName = r.name.replace(/'/g, "\\'");

                div.innerHTML = `
                    <div class="search-meta" style="display:flex; align-items:center; gap:10px;">
                        <img src="${stationObj.image}" onerror="handleImageError(this, '${safeName}')" style="width:40px; height:40px; border-radius:8px; object-fit:cover; background:#1e1229;">
                        <div style="overflow:hidden;">
                            <div class="search-ep-title">${r.name}</div>
                            <div class="search-pod-name">${r.country || 'Global'} ‚Ä¢ ${r.bitrate}k</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${playBtn}
                        ${actionBtn}
                    </div>`;
                searchResults.appendChild(div);
            });
            lucide.createIcons();
        }

        function addFromSearch(station) {
            if(!myStations.some(s=>s.id === station.id)) {
                station.favorite = true; 
                myStations.push(station);
                saveData();
                showDialog('info', 'Salvata', `Stazione <strong>${station.name}</strong> aggiunta al Tuner.`);
                const currentSearchQuery = searchInput.value;
                if(currentSearchQuery.length > 2) performGlobalSearch(currentSearchQuery);
            }
        }

        function previewStation(station) {
            playStream(station);
        }

        function showDialog(type, title, msg, onConfirm = null) {
            const m = document.getElementById('app-modal');
            const iconCont = document.getElementById('modal-icon-container');
            if(type === 'info') iconCont.style.display = 'none';
            else { iconCont.style.display = 'block'; iconCont.innerText = type==='danger'?'üóëÔ∏è':'‚ö†Ô∏è'; }
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = msg;
            const btns = document.getElementById('modal-buttons'); btns.innerHTML = '';
            const close = () => m.classList.remove('open');
            if(onConfirm) {
                const b1 = document.createElement('button'); b1.className='btn-secondary'; b1.innerText='Annulla'; b1.onclick=close; b1.style.marginTop='0';
                const b2 = document.createElement('button'); b2.className='btn-primary'; b2.innerText='Conferma'; b2.style.background='var(--danger)'; b2.onclick=()=>{close();onConfirm();};
                btns.append(b1,b2);
            } else {
                const b1 = document.createElement('button'); b1.className='btn-primary'; b1.innerText='Chiudi'; b1.onclick=close; btns.appendChild(b1);
            }
            m.classList.add('open');
            lucide.createIcons();
        }

        function showInfo() {
            showDialog('info', '', `
                <div style="text-align:center">
                    <i data-lucide="radio" class="intro-logo" style="width:50px; height:50px;"></i>
                    <h3 style="font-weight: 600; letter-spacing: 2px; margin-top:10px">AIRBEAT<span style="color:var(--accent); font-weight:700;">.</span></h3>
                    <ul class="feature-list" style="list-style:none; padding:0; text-align:left; color:var(--text-muted); font-size:13px; margin:20px 0;">
                        <li style="margin-bottom:8px"><i data-lucide="check" style="width:14px; margin-right:5px"></i> +30.000 Stazioni Radio</li>
                        <li style="margin-bottom:8px"><i data-lucide="check" style="width:14px; margin-right:5px"></i> Copertine Dinamiche</li>
                        <li style="margin-bottom:8px"><i data-lucide="check" style="width:14px; margin-right:5px"></i> Player HLS/MP3 Live</li>
                    </ul>
                    <div style="margin-top:20px; font-size:12px; color:#64748b; border-top:1px solid var(--border-color); padding-top:15px;">
                        Dev by NeRO per Utente
                    </div>
                </div>
            `);
        }

        function toggleAppFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => { console.log(e); });
            } else {
                document.exitFullscreen();
            }
        }

        function toggleZenMode() {
            if (document.body.classList.contains('zen-active')) {
                document.body.classList.remove('zen-active');
            } else {
                document.body.classList.add('zen-active');
                if(currentPlayingStation) {
                    const imgUrl = currentPlayingStation.image;
                    zenCover.onerror = () => { zenCover.src = getDynamicCover(currentPlayingStation.name); };
                    if(!imgUrl) zenCover.src = getDynamicCover(currentPlayingStation.name);
                    else zenCover.src = imgUrl;

                    zenPodName.innerText = currentPlayingStation.country || "World";
                    zenTitle.innerText = currentPlayingStation.name;
                }
                if(!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e=>{});
                }
            }
        }

        function switchView(viewId, btnElement = null) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(btnElement) {
                document.querySelectorAll('.menu-link').forEach(b => b.classList.remove('active'));
                if(btnElement.classList.contains('menu-link') && !btnElement.classList.contains('menu-icon-only')) {
                    btnElement.classList.add('active');
                }
            }
            scrollContainer.scrollTop = 0;
        }

        function loadData() { const d=localStorage.getItem(STORAGE_KEY); if(d) myStations=JSON.parse(d); }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(myStations)); }

        // SORTING
        function setSort(type) {
            currentSort = type;
            applySort();
        }
        function applySort() {
            const type = currentSort;
            document.querySelectorAll('.sort-btn').forEach(b => {
                b.style.background = 'transparent';
                b.style.color = 'var(--text-muted)';
            });
            const activeBtn = document.getElementById(`sort-btn-${type}`);
            if(activeBtn) {
                activeBtn.style.background = 'var(--accent)';
                activeBtn.style.color = 'white';
            }
            renderLibrary();
        }

        function renderLibrary() {
            const c = document.getElementById('library-grid-content'); c.innerHTML = '';
            
            let sortedData = [...myStations]; 

            if(currentSort === 'fav') {
                sortedData = sortedData.filter(p => p.favorite === true);
            } else if(currentSort === 'name') {
                sortedData.sort((a,b) => a.name.localeCompare(b.name));
            } else if(currentSort === 'country') {
                sortedData.sort((a,b) => (a.country||"").localeCompare(b.country||""));
            }

            if(sortedData.length===0) { 
                document.getElementById('empty-state').style.display='block'; 
                return; 
            }
            document.getElementById('empty-state').style.display='none';
            
            sortedData.forEach((p) => {
                const card = document.createElement('div'); card.className = 'podcast-card';
                card.onclick=()=>{ openStationDetails(p); }
                let badge = p.favorite ? `<div class="fav-badge"><i data-lucide="heart" style="fill:#ef4444; color:#ef4444"></i></div>` : '';
                
                const img = document.createElement('img');
                img.className = 'card-image';
                img.onerror = () => { img.src = getDynamicCover(p.name); };
                if(p.image && p.image.trim() !== "") img.src = p.image;
                else img.src = getDynamicCover(p.name);

                card.innerHTML = `${badge}<div class="card-title">${p.name}</div><div class="card-sub">${p.country || 'Unknown'}</div>`;
                card.insertBefore(img, card.children[1]); 
                c.appendChild(card);
            });
            lucide.createIcons();
        }

        function toggleFavorite(id) {
            const p = myStations.find(i=>i.id===id);
            if(p) {
                p.favorite = !p.favorite;
                saveData();
                updateFavBtn(p.favorite);
                if(currentSort === 'fav') renderLibrary();
                else {
                    renderLibrary();
                }
            }
        }

        function updateFavBtn(isFav) {
            const btn = document.getElementById('btn-fav-current');
            if(isFav) {
                btn.classList.add('active-fav');
                btn.innerHTML = `<i data-lucide="heart" style="fill:currentColor"></i> <span>Preferito</span>`;
            } else {
                btn.classList.remove('active-fav');
                btn.innerHTML = `<i data-lucide="heart"></i> <span>Preferito</span>`;
            }
            lucide.createIcons();
        }

        function deleteStation(id, fromSearch = false) { 
            if(fromSearch) {
                myStations = myStations.filter(p=>p.id!==id);
                saveData();
                const currentSearchQuery = searchInput.value;
                if(currentSearchQuery.length > 2) performGlobalSearch(currentSearchQuery);
                return;
            }
            showDialog('danger','Elimina Stazione','Rimuovere dai preferiti?', ()=>{ 
                myStations=myStations.filter(p=>p.id!==id); saveData(); applySort(); switchView('view-library', document.querySelector('.menu-link'));
            }); 
        }

        function resetForm() { 
            document.getElementById('inp-id').value=""; document.getElementById('inp-url').value=""; 
            document.getElementById('inp-name').value=""; document.getElementById('inp-country').value=""; 
            document.getElementById('inp-img').value="";
        }
        
        // --- EDIT LOGIC ---
        function editStation(id) {
            const p = myStations.find(i=>i.id===id); if(!p)return;
            document.getElementById('inp-id').value = p.id; 
            document.getElementById('inp-url').value = p.url;
            document.getElementById('inp-name').value = p.name; 
            document.getElementById('inp-country').value = p.country || "";
            document.getElementById('inp-img').value = p.image || "";
            
            switchView('view-manage', document.querySelectorAll('.menu-link')[1]); 
        }

        // Add/Save Custom Station
        document.getElementById('btn-save').onclick = () => {
            const idStr = document.getElementById('inp-id').value; 
            const url = document.getElementById('inp-url').value; 
            const name = document.getElementById('inp-name').value; 
            const country = document.getElementById('inp-country').value;
            const img = document.getElementById('inp-img').value;
            
            if(!url||!name) return showDialog('danger','Errore','URL e Nome sono obbligatori');
            
            if(idStr) { 
                // EDIT EXISTING
                const idx = myStations.findIndex(p=>p.id==idStr); 
                if(idx!==-1) {
                    myStations[idx].name = name;
                    myStations[idx].url = url;
                    myStations[idx].country = country;
                    myStations[idx].image = img;
                }
            } else { 
                // ADD NEW
                const newStation = {
                    id: 'custom-' + Date.now(),
                    name, url, country, image: img,
                    favorite: true, tags: 'custom'
                };
                myStations.push(newStation); 
            }
            saveData(); applySort(); switchView('view-library', document.querySelectorAll('.menu-link')[0]);
        };

        function openCurrentStationView() {
            if (document.body.classList.contains('zen-active')) {
                toggleZenMode();
            }
            if (currentPlayingStation) {
                openStationDetails(currentPlayingStation);
            }
        }

        function openStationDetails(p) {
            switchView('view-player-details');
            
            // Setup buttons
            document.getElementById('btn-delete-current').onclick = () => deleteStation(p.id);
            document.getElementById('btn-edit-current').onclick = () => editStation(p.id);

            const favBtn = document.getElementById('btn-fav-current');
            favBtn.onclick = () => toggleFavorite(p.id);
            updateFavBtn(p.favorite);

            // Populate Info
            document.getElementById('detail-title').innerText = p.name; 
            
            const detImg = document.getElementById('detail-img');
            detImg.onerror = () => { detImg.src = getDynamicCover(p.name); };
            if(p.image && p.image.trim() !== '') detImg.src = p.image;
            else detImg.src = getDynamicCover(p.name);

            document.getElementById('detail-meta').innerText = `${p.country || 'Global'} ‚Ä¢ ${p.tags || 'Music'}`;
            document.getElementById('detail-url').innerText = p.url;
            
            // Check play state
            if(currentPlayingStation && currentPlayingStation.id === p.id && !audio.paused) {
                detailPlayBtn.innerHTML = '<i data-lucide="pause" style="width:28px; height:28px"></i>';
            } else {
                detailPlayBtn.innerHTML = '<i data-lucide="play" style="width:28px; height:28px"></i>';
            }
            detailPlayBtn.onclick = () => playStream(p);

            // Tech info
            document.getElementById('detail-codec').innerText = "Audio Stream";
            document.getElementById('detail-bitrate').innerText = "Variable";

            lucide.createIcons();
        }

        function playStream(station) {
            const isSame = currentPlayingStation && currentPlayingStation.id === station.id;
            
            if (isSame && !audio.paused) {
                audio.pause();
                updatePlayIcons(false);
            } else {
                if(!isSame) {
                    audio.src = station.url;
                    currentPlayingStation = station;
                    
                    pillTitle.innerText = station.name;
                    pillPlayer.classList.add('visible');
                    
                    zenTitle.innerText = station.name;
                    zenPodName.innerText = station.country || "";
                    
                    zenCover.onerror = () => { zenCover.src = getDynamicCover(station.name); };
                    if(station.image) zenCover.src = station.image;
                    else zenCover.src = getDynamicCover(station.name);
                }
                
                audio.play().then(() => {
                    updatePlayIcons(true);
                }).catch(e => {
                    console.error(e);
                    showDialog('danger', 'Errore Riproduzione', 'Impossibile riprodurre questo stream.<br>La stazione potrebbe essere offline.');
                    updatePlayIcons(false);
                });
            }
        }

        function toggleGlobalPlay() {
            if(!currentPlayingStation) return;
            if(audio.paused) { 
                audio.play(); 
                updatePlayIcons(true);
            } else { 
                audio.pause(); 
                updatePlayIcons(false);
            }
        }

        function updatePlayIcons(isPlaying) {
            const icon = isPlaying 
                ? '<i data-lucide="pause" style="width:28px; height:28px"></i>' 
                : '<i data-lucide="play" style="width:28px; height:28px"></i>';
            
            const pillIcon = isPlaying ? '<i data-lucide="pause"></i>' : '<i data-lucide="play"></i>';

            detailPlayBtn.innerHTML = icon;
            pillPlayBtn.innerHTML = pillIcon;
            
            if(isPlaying) zenCover.style.animationPlayState = 'running';
            else zenCover.style.animationPlayState = 'paused';

            lucide.createIcons();
        }

        document.getElementById('btn-export').onclick=()=>{
            const a=document.createElement('a'); 
            a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(myStations)); 
            a.download="airbeat_stations.json"; 
            a.click();
        };
        document.getElementById('btn-import').onclick=()=>document.getElementById('file-import').click();
        document.getElementById('file-import').onchange=(e)=>{
            const r=new FileReader(); 
            r.onload=(ev)=>{ 
                try{ 
                    myStations=JSON.parse(ev.target.result); 
                    saveData(); applySort(); 
                    showDialog('info','Fatto','Importazione frequenze completata!'); 
                    switchView('view-library', document.querySelector('.menu-link')); 
                }catch{ showDialog('danger','Errore','File JSON non valido'); } 
            }; 
            r.readAsText(e.target.files[0]);
        };
    </script>
</body>
</html>